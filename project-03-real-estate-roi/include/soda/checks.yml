# ============================================
# SODA Data Quality Checks
# Real Estate ROI Predictor
# ============================================

# Checks for fact_transactions table
checks for core.fact_transactions:
  # Schema checks
  - schema:
      fail:
        when required column missing:
          - transaction_id
          - location_id
          - transaction_date
          - price

  # Completeness checks
  - missing_count(transaction_id) = 0
  - missing_count(price) = 0
  - missing_count(transaction_date) = 0

  # Uniqueness checks
  - duplicate_count(source_id) = 0

  # Validity checks
  - invalid_count(price) = 0:
      valid min: 0
  - invalid_count(price_per_sqm) = 0:
      valid min: 0
      valid max: 500000  # Reasonable max price per sqm

  # Freshness check
  - freshness(loaded_at) < 2d

# Checks for dim_locations table
checks for core.dim_locations:
  - missing_count(location_id) = 0
  - missing_count(city) = 0
  - duplicate_count(location_id) = 0

  # Coordinate validity
  - invalid_count(lat) = 0:
      valid min: 29.0  # Southern Israel
      valid max: 34.0  # Northern Israel
  - invalid_count(lng) = 0:
      valid min: 34.0  # Western Israel
      valid max: 36.0  # Eastern Israel

# Checks for fact_listings table
checks for core.fact_listings:
  - missing_count(listing_id) = 0
  - missing_count(source) = 0
  - invalid_count(asking_price) = 0:
      valid min: 0

# Custom SQL checks
checks for core.fact_transactions:
  - price_sanity_check:
      price_vs_sqm fail query: |
        SELECT COUNT(*)
        FROM core.fact_transactions
        WHERE price_per_sqm > 0
          AND price_per_sqm < 1000
      fail condition: price_vs_sqm > 0

# Analytics checks
checks for analytics.agg_roi_metrics:
  - missing_count(roi_score) = 0:
      filter: calc_date = CURRENT_DATE - 1
  - invalid_count(roi_score) = 0:
      valid min: 0
      valid max: 100
